sudo: required
services:
  - docker

# Tag the image so we can refer it later since we cannot copy the image id returned by build command
# Creating image only for web project to run tests
# We should ideall run tests on all sub-projects
before_install:
  - docker build -t vaibhavdesai137/multi-containers-workflow-webapp -f ./web-app/Dockerfile.dev ./web-app
  # - docker build other-project-1
  # - docker build other-project-2

# Use the hyphens to terminate tests else "npm run test" will wait for user inputs
script:
  - docker run vaibhavdesai137/multi-containers-workflow-webapp npm run test -- --coverage --forceExit

# We need all images for prod so lets do that here
# After building, upload to docker hub
after_success:
  # Build images
  - docker build -t vaibhavdesai137/multi-containers-workflow-workerapp -f ./worker-app/Dockerfile.prod ./worker-app
  - docker build -t vaibhavdesai137/multi-containers-workflow-apiapp -f ./api-app/Dockerfile.prod ./api-app
  - docker build -t vaibhavdesai137/multi-containers-workflow-webapp -f ./web-app/Dockerfile.prod ./web-app
  - docker build -t vaibhavdesai137/multi-containers-workflow-nginx -f ./nginx/Dockerfile.prod ./nginx
  # Login to docker
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
  # Push to docker
  - docker push vaibhavdesai137/multi-containers-workflow-workerapp
  - docker push vaibhavdesai137/multi-containers-workflow-apiapp
  - docker push vaibhavdesai137/multi-containers-workflow-webapp
  - docker push vaibhavdesai137/multi-containers-workflow-nginx
